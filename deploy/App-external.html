<!DOCTYPE html>
<html>
<head>
    <title>Random App Name87393</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",itemId:"pulldown-container",layout:{type:"hbox",align:"stretch"}},{xtype:"container",itemId:"text-container",layout:{type:"anchor",align:"stretch"}}],launch:function(){console.log("Basic Rally Grid"),this._loadIterations()},_loadIterations:function(){var iterPicker={xtype:"rallyiterationcombobox",itemId:"iter-picker",fieldLabel:"Iteration",labelAlign:"right",width:"300",listeners:{ready:this._loadData,select:this._loadData,scope:this}};this.down("#pulldown-container").add(iterPicker)},_getFilters:function(iterVal){var iterationFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration",operation:"=",value:iterVal});return iterationFilter},_loadData:function(){var iterRef=this.down("#iter-picker").getRecord().get("_ref"),comboFilter=this._getFilters(iterRef);this.myStore?(this.myStore.setFilter(comboFilter),this.myStore.load()):this.myStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:["UserStory","Defect"],autoLoad:!0,filters:comboFilter,listeners:{load:function(store,stories){this.mytext||this._createText(stories),this._getArtifactHtml(stories)},scope:this},fetch:["FormattedID","Name","Owner","ScheduleState","PlanEstimate","Description","RevisionHistory","Revisions","RevisionNumber"]})},_createText:function(stories){this.mytext={itemId:"texted",xtype:"rallyrichtexteditor",style:{width:"100%",height:"100%"},listeners:{ready:this._getArtifactHtml,scope:this}},this.down("#text-container").add(this.mytext)},_setText:function(string){this.down("#texted").setValue(string)},_getText:function(){return this.down("#texted").getValue()},_loadRevHistoryModel:function(model,story){return console.log("LOAD MODEL:"),model.load(Rally.util.Ref.getOidFromRef(story.get("RevisionHistory")),{success:function(record){record.getCollection("Revisions").load({fetch:["Description"],scope:this,callback:function(revisions){console.log(revisions)}})}}),1e3},_getArtifactHtml:function(data){var htmlStr="";Ext.Array.each(data,function(rec){revHisModel=Rally.data.ModelFactory.getModel({type:"RevisionHistory",success:function(model){pEst=rec.get("PlanEstimate"),state=rec.get("ScheduleState"),recStr=rec.get("FormattedID")+": "+rec.get("Name"),pEst&&pEst>0?recStr=recStr+" ("+pEst+"pts)":state&&"Incomplete"==state&&(pEst=this._loadRevHistoryModel(model,rec),recStr=recStr+" ("+pEst+"pts)",recStr+=" (77pts)"),htmlStr="Accepted"==state||"Completed"==state?htmlStr+'<font color="green">'+recStr+"</font><BR>":"Incomplete"==state?htmlStr+'<font color="red">'+recStr+"</font><BR>":htmlStr+recStr+"<BR>",console.log("SET TEXT: "+htmlStr),this._setText(htmlStr)},scope:this})},this),console.log("RETURNING STRING")}});

            Rally.launchApp('CustomApp', {
                name:"Random App Name87393",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
